name: Build and Deploy CivilRadar Api

on:
  pull_request:
    branches:
      - dev
      - main
  workflow_call:

jobs:
 build-and-deploy:
   name: Build and Deploy
   runs-on: ubuntu-24.04
   container:
    image: ubuntu:noble
   steps:
   - name: Checking out from source control
     uses: actions/checkout@v3
   - name: Installing dependencies
     run: ./tools/install_dependencies.bash
   - name: Running postgresql
     run: service postgresql start
   - name: Creating venv
     run: bash -c "python3 -m venv .venv && source .venv/bin/activate && pip install -r CityHorizon/requirements.txt"
   - name: Run Tests
     run: bash -c "git checkout b559caa725a2ba484910ef73e8428065985ba730 && source .venv/bin/activate &&\
          ./CityHorizon/manage.py test Authentication.tests --exclude-tag=unstable --parallel"
